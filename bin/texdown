#!/bin/bash
#
# texdown - Convert Markdown files to LaTeX/PDF using TeXDown.jl
#
# Usage:
#   texdown pdf <file.md> [template]   - Generate PDF (default)
#   texdown tex <file.md> [template]   - Generate LaTeX only
#   texdown <file.md>                  - Generate PDF with todo_list template
#
# Templates: todo_list (default), research_note, recipe
#

set -e

# Find Julia executable
JULIA=""
if command -v julia &> /dev/null; then
    JULIA="julia"
elif [[ -x "$HOME/.juliaup/bin/julia" ]]; then
    JULIA="$HOME/.juliaup/bin/julia"
elif [[ -d "/Applications" ]]; then
    # Find newest Julia.app
    JULIA=$(find /Applications -name "julia" -path "*/Julia-*/bin/*" 2>/dev/null | sort -V | tail -1)
fi

if [[ -z "$JULIA" ]]; then
    echo "Error: Julia not found. Install via juliaup or from julialang.org"
    exit 1
fi

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# Parse arguments
ACTION=""
FILE=""
TEMPLATE="todo_list"

if [[ $# -eq 0 ]]; then
    echo "Usage: texdown [pdf|tex] <file.md> [template]"
    echo ""
    echo "Actions:"
    echo "  pdf    Generate PDF (default if omitted)"
    echo "  tex    Generate LaTeX file only"
    echo ""
    echo "Templates: todo_list (default), research_note, recipe"
    exit 1
fi

# Check if first arg is an action or a file
if [[ "$1" == "pdf" || "$1" == "tex" ]]; then
    ACTION="$1"
    FILE="$2"
    TEMPLATE="${3:-todo_list}"
else
    # First arg is the file, default to pdf
    ACTION="pdf"
    FILE="$1"
    TEMPLATE="${2:-todo_list}"
fi

# Validate file argument
if [[ -z "$FILE" ]]; then
    echo "Error: No file specified"
    exit 1
fi

if [[ ! -f "$FILE" ]]; then
    echo "Error: File not found: $FILE"
    exit 1
fi

# Convert to absolute path
FILE="$(cd "$(dirname "$FILE")" && pwd)/$(basename "$FILE")"

# Run Julia with TeXDown
"$JULIA" --project="$PROJECT_DIR" -e "
    using TeXDown
    make_${ACTION}(\"$FILE\", $TEMPLATE)
"
